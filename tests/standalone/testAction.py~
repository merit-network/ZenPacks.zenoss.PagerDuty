##############################################################################
#
# Copyright (C) Zenoss, Inc. 2018 all rights reserved.
#
# This content is made available according to terms specified in
# License.zenoss under the directory where your Zenoss product is installed.
#
##############################################################################

import unittest
from mock import Mock
import Globals
from ZenPacks.zenoss.PS.BOM.CherwellIncMan.action import CherwellAction, CherwellAPIException

WSDL_URL = 'https://bomcsm.cherwellondemand.com/CherwellService/api.asmx?WSDL'
TEST_USERNAME = 'auser'
TEST_PASSWORD = 'password'
RETRIES = 3
TIMEOUT = 5
REC_ID = "94387c41a3026d126b2ae046c9908a74cf9a62b870"
PUBLIC_ID = "ASK20537"
TEST_XML_WITH_REC_ID = '<BusinessObject IDREF="6dd53665c0c24cab86870a21cf6434ae" Name="Incident" RecID="'+REC_ID+'"><FieldList><Field IDREF="fa03d51b709e4a6eb2d52885b2ef7e04" Name="RecID">'+REC_ID+'</Field></FieldList></BusinessObject>'


class MockNotification:

    def __init__(self):
        self.content = {
            'url': WSDL_URL,
            'proxyUrl': None,
            'proxyUsername': None,
            'username': TEST_USERNAME,
            'password': TEST_PASSWORD,
            'retries': RETRIES,
            'timeout': TIMEOUT
        }

class TestCherwellAction(unittest.TestCase):

    def testGetWsdlUrl(self):
        notification = MockNotification()
        cherwellAction = CherwellAction()
        self.assertEquals(WSDL_URL, cherwellAction.getWsdlUrl(notification))

    def testExtractFieldFromBusinessObjectXMLFindsRecId(self):
        cherwellAction = CherwellAction()
        actualRecId = cherwellAction._extractFieldFromBusinessObjectXML('RecID',TEST_XML_WITH_REC_ID)
        self.assertEquals(REC_ID, actualRecId)

    def testExtractFieldFromBusinessObjectXMLRaisesExceptionForMissingField(self):
        cherwellAction = CherwellAction()
        self.assertRaises(CherwellAPIException, cherwellAction._extractFieldFromBusinessObjectXML, 'NotAField',TEST_XML_WITH_REC_ID)


    def testIsRecIdReturnsTrueForRecId(self):
        self.assertTrue(CherwellAction.isRecId(REC_ID))

    def testIsRecIdReturnsFalseForPublicId(self):
        self.assertFalse(CherwellAction.isRecId(PUBLIC_ID))
